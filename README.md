# K3s Кластер с GitOps и Jenkins HA Deployment

## Обзор задачи

Данный проект демонстрирует автоматизированное развертывание K3s кластера с использованием Terraform на Yandex Cloud и последующую настройку GitOps с помощью Flux CD, включая развертывание Jenkins в конфигурации.

## Предварительные требования

- Terraform
- Yandex Cloud аккаунт
- Установленный `kubectl`
- Установленный Flux CD CLI
- Jenkins

## Шаги развертывания

### 1. Создание инфраструктуры с помощью Terraform

```bash
# Инициализация Terraform
cd terraform
terraform init

# Планирование развертывания
terraform plan

# Применение конфигурации
terraform apply
```

#### Детали конфигурации Terraform:
- Создание 3 виртуальных машин в Yandex Cloud
- Операционная система: Ubuntu 22.04
- Спецификации ВМ: 
  - Cores: 2
  - Memory: 4 ГБ
  - Disk: 50 ГБ

### 2. Установка K3s кластера

## Шаги для каждой машины

### Шаг 1: Подготовка всех машин

2. Обновите все пакеты:

   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

### Шаг 2: Установка K3s на мастер-ноду

На **мастер-нода** (машина, которая будет контролировать кластер):

1. Выполните команду для установки K3s:

   ```bash
   curl -sfL https://get.k3s.io | sh -
   ```

2. После успешной установки, получите токен для добавления рабочих нод:

   ```bash
   sudo cat /var/lib/rancher/k3s/server/node-token
   ```

   Скопируйте токен, он будет использоваться для подключения рабочих нод к кластеру.

3. Для проверки статуса кластера, выполните:

   ```bash
   sudo kubectl get nodes
   ```

   Вы должны увидеть, что ваша мастер-нода теперь работает как **control-plane**.

### Шаг 3: Установка K3s на рабочие ноды

На **каждой рабочей ноде**:

1. Установите K3s с указанием адреса мастер-ноды и токена:

   ```bash
   curl -sfL https://get.k3s.io | K3S_URL=https://<IP-МАСТЕР-НОДЫ>:6443 K3S_TOKEN=<ТОКЕН> sh -
   ```

   Замените `<IP-МАСТЕР-НОДЫ>` на IP адрес вашей мастер-ноды, а `<ТОКЕН>` на токен, который вы получили ранее на мастер-ноде.

2. После установки, проверьте, что нода подключилась к кластеру:

   ```bash
   sudo kubectl get nodes
   ```

   Вы должны увидеть рабочую ноду как "Ready".

### Шаг 4: Проверка состояния кластера

На **мастер-ноде** выполните команду для получения состояния всех нод:

```bash
kubectl get nodes
```

Вы должны увидеть все ноды, включая мастер и рабочие, в статусе **Ready**.

### Дополнительные шаги

- Если необходимо, настройте `kubectl` для работы с кластером, создав символическую ссылку на kubeconfig файл:
  
  ```bash
  sudo ln -s /etc/rancher/k3s/k3s.yaml ~/.kube/config
  ```

### 3. Настройка GitOps с Flux CD

```bash
# Инициализация Flux в кластере
flux bootstrap github \
  --owner=<ваш-github-username> \
  --repository=<название-репозитория> \
  --branch=main \
  --path=./flux/deploy
```

### 4. Развертывание Jenkins через GitOps

Flux автоматически применит манифесты из директории `flux/deploy`:
- `jenkins-helmrepository.yaml`: Источник чарта Jenkins
- `jenkins-helmrelease.yaml`: Конфигурация развертывания Jenkins
- `jenkins-agent-deployment.yaml`: Статические агенты Jenkins
- `jenkins-agent-secret.yaml`: Секрет для аутентификации агентов

### 5. Настройка резервного копирования Jenkins

Создан `backup-cronjob.yaml` для автоматического бэкапа Jenkins каждые 24 часа.
